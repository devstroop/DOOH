@using System;
@using System.Collections.Generic;
@using System.Net.Http;
@using DOOH.Server.Models.DOOHDB
@using Microsoft.AspNetCore.Components;
@using Microsoft.AspNetCore.Components.Web;
@using Microsoft.JSInterop;
@using Radzen;
@using Radzen.Blazor;
@using System.Text.Json

<RadzenStack Wrap="FlexWrap.Wrap" Orientation="Orientation.Horizontal" Gap="0">
    @foreach (var image in Images ?? new List<string>())
    {
        <RadzenStack Style="width: 96px; height: 96px; position: relative;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenImage Path="@_validatedImages.GetValueOrDefault(image, "/images/warning.png")" Style="width: 84px; height: 84px; object-fit: cover; border-radius: 8px; margin: 6px; border: 1px solid #cfcfcf; box-shadow: 0 0 5px 0 rgba(0, 0, 0, 0.1);" />
            <RadzenButton Class="delete-upload-image" Icon="close" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" Click="@((args) => DeleteImageClick(args, image))" />
            <RadzenProgressBarCircular Value="@progress" Size="ProgressBarCircularSize.Small" Visible="@(progress > 0 && progress < 100)" />
        </RadzenStack>
    }
    <RadzenUpload Id="ddUpload" Icon="add" ChooseText="@uploadText" Url="upload/multiple" Progress="@OnProgress" Auto="true" Multiple="true" Complete="@OnComplete" />
</RadzenStack>
<style>
    .delete-upload-image {
        cursor: pointer;
        position: absolute;
        top: 0;
        right: 0;
    }

    #ddUpload {
        left: 0;
    }

        #ddUpload .rz-fileupload-buttonbar .rz-fileupload-choose .rzi {
            font-size: 24px;
            align-self: center;
            color: #9f9f9f;
        }

        #ddUpload .rz-fileupload-buttonbar .rz-fileupload-choose {
            height: 80px;
            width: 80px;
            text-align: center;
            align-content: center;
            border-radius: 8px;
            border: 2px dashed #bfbfbf;
            background-color: #efefef;
            font-weight: 400;
        }
</style>
@code {
    [Parameter] public List<string> Images { get; set; }
    [Parameter] public Action<List<string>> ImagesChanged { get; set; }
    [Parameter] public Action<int> Progress { get; set; }
    private Dictionary<string, string> _validatedImages = new Dictionary<string, string>();
    private int progress = 0;
    private string uploadText => progress > 0 && progress < 100 ? $"{progress}%" : string.Empty;

    [Inject] private IJSRuntime JSRuntime { get; set; }
    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] private HttpClient HttpClient { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await ValidateImages();
    }

    private async Task ValidateImages()
    {
        foreach (var image in Images ?? new List<string>())
        {
            var validImage = await GetValidImageAsync(image);
            _validatedImages[image] = validImage;
        }
    }

    private async Task<string> GetValidImageAsync(string image)
    {
        if (string.IsNullOrEmpty(image))
        {
            return "/images/no-image.jpg";
        }

        var absoluteUri = image.Trim().StartsWith("http") ? image : $"{NavigationManager.BaseUri}{image}";

        try
        {
            var response = await HttpClient.SendAsync(new HttpRequestMessage(HttpMethod.Head, absoluteUri));

            if (!response.IsSuccessStatusCode)
            {
                return "/images/warning.png";
            }
        }
        catch
        {
            return "/images/warning.png";
        }

        return image;
    }

    private async Task DeleteImageClick(MouseEventArgs args, string image)
    {
        if (!image.Trim().StartsWith("http"))
        {
            await HttpClient.DeleteAsync($"upload/delete?fileName='{image}'");
        }

        _validatedImages.Remove(image);
        Images = Images.Where(x => x != image).ToList();
        ImagesChanged?.Invoke(Images);
    }

    private void OnProgress(UploadProgressArgs args) => Progress?.Invoke(args.Progress);

    private async Task OnComplete(UploadCompleteEventArgs args)
    {
        // example 'args.RawResponse' :
        //{"urls":["/images/1.jpg","/images/2.jpg","/images/3.jpg"]}

        var response = args.RawResponse;
        var urls = JsonSerializer.Deserialize<Dictionary<string, string[]>>(response);

        foreach (var url in urls["urls"])
        {
            Images.Add(url);
        }

        await ValidateImages();
        ImagesChanged?.Invoke(Images);
    }
}
